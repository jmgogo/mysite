---
import type { CollectionEntry } from "astro:content";

interface Props {
  posts: CollectionEntry<"blog">[];
  year?: number;
}

const { posts, year = new Date().getFullYear() } = Astro.props;

// Process posts to count activity per day\
const activityMap = new Map<string, number>();

posts.forEach((post) => {
  const publishedDate = new Date(post.data.pubDate);
  const updatedDate = post.data.updatedDate
    ? new Date(post.data.updatedDate)
    : null;

  // Count published date
  if (publishedDate.getFullYear() === year) {
    const dateKey = publishedDate.toISOString().split("T")[0];
    activityMap.set(dateKey, (activityMap.get(dateKey) || 0) + 1);
  }

  // Count updated date
  if (updatedDate && updatedDate.getFullYear() === year) {
    const dateKey = updatedDate.toISOString().split("T")[0];
    activityMap.set(dateKey, (activityMap.get(dateKey) || 0) + 1);
  }
});

// Get color intensity based on activity count
function getColorClass(count: number): string {
  if (count === 0) return "bg-gray-100";
  if (count === 1) return "bg-green-200";
  if (count === 2) return "bg-green-400";
  if (count === 3) return "bg-green-600";
  return "bg-green-800";
}

// Generate calendar grid data
const startDate = new Date(year, 0, 1);
const endDate = new Date(year, 11, 31);

// Find the Sunday before or on the start date
const firstSunday = new Date(startDate);
firstSunday.setDate(startDate.getDate() - startDate.getDay());

// Find the Saturday after or on the end date
const lastSaturday = new Date(endDate);
lastSaturday.setDate(endDate.getDate() + (6 - endDate.getDay()));

// Calculate number of weeks
const weeks: Date[][] = [];
let currentDate = new Date(firstSunday);

while (currentDate <= lastSaturday) {
  const week: Date[] = [];
  for (let day = 0; day < 7; day++) {
    week.push(new Date(currentDate));
    currentDate.setDate(currentDate.getDate() + 1);
  }
  weeks.push(week);
}

// Calculate month headers
interface MonthHeader {
  month: string;
  startCol: number;
  span: number;
}

const monthHeaders: MonthHeader[] = [];

// Generate month headers
const monthNames = Array.from({ length: 12 }, (_, i) =>
  new Intl.DateTimeFormat("en-US", { month: "short" }).format(
    new Date(year, i),
  ),
);

for (let month = 0; month < 12; month++) {
  const firstOfMonth = new Date(year, month, 1);
  const lastOfMonth = new Date(year, month + 1, 0);

  // Find first full week (starts on Sunday)
  let firstFullWeek = new Date(firstOfMonth);
  if (firstOfMonth.getDay() !== 0) {
    firstFullWeek.setDate(firstOfMonth.getDate() + (7 - firstOfMonth.getDay()));
  }

  // Find the week index for the first full week
  const startWeekIndex = weeks.findIndex(
    (week) => week[0] <= firstFullWeek && week[6] >= firstFullWeek,
  );

  // Find the last week that contains days from this month
  let lastWeekIndex = weeks.findIndex((week) =>
    week.some((day) => day.getMonth() === month && day.getFullYear() === year),
  );

  // Find the actual last week
  for (let i = lastWeekIndex + 1; i < weeks.length; i++) {
    if (
      weeks[i].some(
        (day) => day.getMonth() === month && day.getFullYear() === year,
      )
    ) {
      lastWeekIndex = i;
    } else {
      break;
    }
  }

  if (
    startWeekIndex !== -1 &&
    lastWeekIndex !== -1 &&
    startWeekIndex <= lastWeekIndex
  ) {
    monthHeaders.push({
      month: monthNames[month],
      startCol: startWeekIndex,
      span: lastWeekIndex - startWeekIndex + 1,
    });
  }
}

// Get activity data for a specific date
function getActivityForDate(date: Date): { count: number; posts: any[] } {
  const dateKey = date.toISOString().split("T")[0];
  const count = activityMap.get(dateKey) || 0;

  const postsOnDate = posts.filter((post) => {
    const publishedDate = new Date(post.data.pubDate);
    const updatedDate = post.data.updatedDate
      ? new Date(post.data.updatedDate)
      : null;

    const publishedKey = publishedDate.toISOString().split("T")[0];
    const updatedKey = updatedDate
      ? updatedDate.toISOString().split("T")[0]
      : null;

    return publishedKey === dateKey || updatedKey === dateKey;
  });

  return { count, posts: postsOnDate };
}

const dayLabels = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
---

<div class="flex">
  <div class="contribution-graph font-sans">
    <div class="graph-container">
      <table class="graph-table">
        <thead>
          <tr>
            <th class="row-label-spacer"></th>
            {
              monthHeaders.map((header) => (
                <th colspan={header.span} class="month-header">
                  {header.month}
                </th>
              ))
            }
          </tr>
        </thead>
        <tbody>
          {
            [0, 1, 2, 3, 4, 5, 6].map((dayIndex) => (
              <tr class="graph-row">
                <td class="day-label-cell">
                  <span class="day-label">{dayLabels[dayIndex]}</span>
                </td>
                {weeks.map((week) => {
                  const date = week[dayIndex];
                  const { count, posts: dayPosts } = getActivityForDate(date);
                  const isCurrentYear = date.getFullYear() === year;
                  const colorClass = isCurrentYear
                    ? getColorClass(count)
                    : "bg-gray-50";

                  return (
                    <td
                      class={`graph-cell ${colorClass}`}
                      title={
                        isCurrentYear && count > 0
                          ? `${date.toLocaleDateString()}: ${count} post${count > 1 ? "s" : ""} - ${dayPosts.map((p) => p.data.title).join(", ")}`
                          : date.toLocaleDateString()
                      }
                      data-date={date.toISOString().split("T")[0]}
                      data-count={count}
                    />
                  );
                })}
              </tr>
            ))
          }
        </tbody>
      </table>
    </div>
    <div class="flex flex-wrap justify-between gap-x-4">
      <h3 class="inline-block font-bold italic">Blog Activity</h3>
      <div class="legend">
        <span class="legend-label">Less</span>
        <div class="legend-cell bg-gray-100"></div>
        <div class="legend-cell bg-green-200"></div>
        <div class="legend-cell bg-green-400"></div>
        <div class="legend-cell bg-green-600"></div>
        <div class="legend-cell bg-green-800"></div>
        <span class="legend-label">More</span>
      </div>
    </div>
  </div>
</div>

<style>
  .contribution-graph {
    overflow-x: auto;
    margin-inline: 1rem;
  }

  .graph-container {
    position: relative;
    padding-bottom: 0.5rem;
  }

  .graph-table {
    border-collapse: separate;
    border-spacing: 2px;
    /* Prevent table from shrinking */
    table-layout: fixed;
  }

  .month-header {
    font-size: 0.75rem;
    font-weight: 400;
    color: #57606a;
    text-align: left;
    padding-bottom: 0.25rem;
  }

  /* Added spacer cell for row labels in header */
  .row-label-spacer {
    min-width: 30px;
  }

  /* Position row relatively to contain absolute positioned label */
  .graph-row {
    height: 10px;
    position: relative;
  }

  /* Day label cell with fixed width to prevent shrinking */
  .day-label-cell {
    width: 30px;
    min-width: 30px;
    height: 10px;
    padding: 0;
    position: relative;
  }

  /* Absolutely positioned day label to avoid affecting row height */
  .day-label {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.625rem;
    color: #57606a;
    white-space: nowrap;
  }

  /* Fixed cell dimensions to prevent shrinking */
  .graph-cell {
    min-width: 10px;
    min-height: 10px;
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.1s ease;
    padding: 0;
  }

  .graph-cell:hover {
    outline: 2px solid rgba(0, 0, 0, 0.3);
    outline-offset: 0;
  }

  .legend {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: #57606a;
  }

  .legend-label {
    margin: 0 0.25rem;
  }

  .legend-cell {
    width: 10px;
    height: 10px;
    border-radius: 2px;
  }
</style>
